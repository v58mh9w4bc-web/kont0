<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRM ‚Äî –ö–æ–Ω—Ç–∏–Ω–µ–Ω—Ç</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&family=Cormorant+Garamond:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Montserrat', sans-serif; }
        .logo-font { font-family: 'Cormorant Garamond', serif; letter-spacing: 0.15em; font-weight: 300; }
        .accent-color { color: #9b8579; }
        .accent-bg { background-color: #c9b8a8; }
        .hover-accent:hover { background-color: #b8a99a; }
        .pastel-bg { background-color: #f5f1ed; }
        .status-new { background-color: #8ba8c4; }
        .status-confirmed { background-color: #a8c9a4; }
        .status-completed { background-color: #b8a99a; }
        .status-cancelled { background-color: #d4a5a5; }
    </style>
</head>
<body class="pastel-bg">
    <!-- Login Screen -->
    <div id="loginScreen" class="min-h-screen flex items-center justify-center">
        <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full mx-4">
            <div class="text-center mb-8">
                <h1 class="text-3xl logo-font accent-color mb-2">–ö–û–ù–¢–ò–ù–ï–ù–¢</h1>
                <h2 class="text-xl font-semibold text-gray-800">CRM-—Å–∏—Å—Ç–µ–º–∞</h2>
                <p class="text-gray-600 text-sm mt-2">–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å –¥–ª—è –¥–æ—Å—Ç—É–ø–∞</p>
            </div>
            
            <form onsubmit="checkPassword(event)">
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">–ü–∞—Ä–æ–ª—å</label>
                    <input type="password" id="passwordInput" required 
                        class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-400 focus:border-transparent"
                        placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å">
                </div>
                
                <button type="submit" class="w-full accent-bg hover-accent text-white py-3 rounded-lg font-semibold transition">
                    –í–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É
                </button>
            </form>
            
            <div id="errorMessage" class="hidden mt-4 p-3 bg-red-50 border border-red-200 rounded-lg">
                <p class="text-red-800 text-sm">–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.</p>
            </div>
            
            <div class="mt-6 text-center">
                <a href="index.html" class="text-gray-500 hover:text-gray-700 text-sm">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ –≥–ª–∞–≤–Ω—É—é</a>
            </div>
        </div>
    </div>

    <!-- Main CRM Content (hidden by default) -->
    <div id="crmContent" class="hidden">
        <!-- Header -->
        <header class="bg-white shadow-sm py-5">
            <div class="container mx-auto px-6 flex justify-between items-center">
                <h1 class="text-3xl logo-font accent-color">–ö–û–ù–¢–ò–ù–ï–ù–¢ ‚Äî CRM</h1>
                <nav class="flex space-x-6">
                    <a href="index.html" class="text-gray-700 hover:text-gray-900 transition">–ì–ª–∞–≤–Ω–∞—è</a>
                    <a href="admin.html" class="text-gray-700 hover:text-gray-900 transition">–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</a>
                    <button onclick="logout()" class="text-red-600 hover:text-red-800 transition">–í—ã–π—Ç–∏</button>
                </nav>
            </div>
        </header>
    <!-- Main Content -->
    <main class="container mx-auto px-6 py-10">
        <div class="bg-white rounded-2xl shadow-lg p-8">
            <div class="flex justify-between items-center mb-8">
                <h2 class="text-3xl logo-font text-gray-800">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞—è–≤–∫–∞–º–∏</h2>
                <div class="flex space-x-4">
                    <div class="relative">
                        <input type="file" id="importFile" accept=".csv,.xlsx,.xls" class="hidden" onchange="importData()">
                        <button onclick="document.getElementById('importFile').click()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg transition flex items-center">
                            üìÅ –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
                        </button>
                    </div>
                    <button onclick="exportToCSV()" class="accent-bg hover-accent text-white px-6 py-2 rounded-lg transition flex items-center">
                        üìä –≠–∫—Å–ø–æ—Ä—Ç CSV
                    </button>
                </div>
            </div>

            <!-- Import Status -->
            <div id="importStatus" class="hidden mb-6 p-4 rounded-lg">
                <div class="flex items-center">
                    <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-gray-600 mr-3"></div>
                    <span id="importMessage">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</span>
                </div>
            </div>

        

            <!-- Data Preview -->
            <div id="dataPreview" class="hidden mb-6">
                <h3 class="text-lg font-semibold mb-4 text-gray-800">–ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä –¥–∞–Ω–Ω—ã—Ö</h3>
                <div class="bg-gray-50 p-4 rounded-lg max-h-60 overflow-auto">
                    <table class="w-full text-sm">
                        <thead id="previewHeaders"></thead>
                        <tbody id="previewData"></tbody>
                    </table>
                </div>
                <div class="mt-4 flex space-x-4">
                    <button onclick="confirmImport()" class="accent-bg hover-accent text-white px-6 py-2 rounded-lg transition">
                        –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∏–º–ø–æ—Ä—Ç
                    </button>
                    <button onclick="cancelImport()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-6 py-2 rounded-lg transition">
                        –û—Ç–º–µ–Ω–∞
                    </button>
                </div>
            </div>

            <!-- Filters -->
            <div class="mb-6 grid md:grid-cols-4 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">–î–∞—Ç–∞</label>
                    <input type="date" id="filterDate" onchange="loadBookings()" class="w-full p-2 border border-gray-300 rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">–ú–∞—Å—Ç–µ—Ä</label>
                    <select id="filterMaster" onchange="loadBookings()" class="w-full p-2 border border-gray-300 rounded-lg">
                        <option value="">–í—Å–µ –º–∞—Å—Ç–µ—Ä–∞</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">–°—Ç–∞—Ç—É—Å</label>
                    <select id="filterStatus" onchange="loadBookings()" class="w-full p-2 border border-gray-300 rounded-lg">
                        <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
                        <option value="–ù–æ–≤–∞—è">–ù–æ–≤–∞—è</option>
                        <option value="–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞</option>
                        <option value="–ó–∞–≤–µ—Ä—à–µ–Ω–∞">–ó–∞–≤–µ—Ä—à–µ–Ω–∞</option>
                        <option value="–û—Ç–º–µ–Ω–µ–Ω–∞">–û—Ç–º–µ–Ω–µ–Ω–∞</option>
                    </select>
                </div>
                <div class="flex items-end">
                    <button onclick="clearFilters()" class="w-full bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg transition">
                        –°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã
                    </button>
                </div>
            </div>

            <!-- Statistics -->
            <div class="grid md:grid-cols-4 gap-6 mb-8">
                <div class="bg-blue-50 p-6 rounded-xl border-l-4 border-blue-300">
                    <div class="text-3xl font-bold text-blue-600" id="statNew">0</div>
                    <div class="text-gray-600 mt-2">–ù–æ–≤—ã–µ –∑–∞—è–≤–∫–∏</div>
                </div>
                <div class="bg-green-50 p-6 rounded-xl border-l-4 border-green-300">
                    <div class="text-3xl font-bold text-green-600" id="statConfirmed">0</div>
                    <div class="text-gray-600 mt-2">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω—ã</div>
                </div>
                <div class="bg-amber-50 p-6 rounded-xl border-l-4 border-amber-300">
                    <div class="text-3xl font-bold text-amber-600" id="statCompleted">0</div>
                    <div class="text-gray-600 mt-2">–ó–∞–≤–µ—Ä—à–µ–Ω—ã</div>
                </div>
                <div class="bg-red-50 p-6 rounded-xl border-l-4 border-red-300">
                    <div class="text-3xl font-bold text-red-600" id="statCancelled">0</div>
                    <div class="text-gray-600 mt-2">–û—Ç–º–µ–Ω–µ–Ω—ã</div>
                </div>
            </div>

            <!-- Bookings Table -->
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">ID</th>
                            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">–î–∞—Ç–∞</th>
                            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">–í—Ä–µ–º—è</th>
                            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">–ö–ª–∏–µ–Ω—Ç</th>
                            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">–ú–∞—Å—Ç–µ—Ä</th>
                            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">–£—Å–ª—É–≥–∞</th>
                            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">–¢–µ–ª–µ—Ñ–æ–Ω</th>
                            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">–°—Ç–∞—Ç—É—Å</th>
                            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">–î–µ–π—Å—Ç–≤–∏—è</th>
                        </tr>
                    </thead>
                    <tbody id="bookingsTable">
                        <tr>
                            <td colspan="9" class="px-4 py-8 text-center text-gray-500">–ó–∞–≥—Ä—É–∑–∫–∞...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <!-- Edit Status Modal -->
    <div id="statusModal" class="fixed inset-0 bg-black bg-opacity-30 hidden items-center justify-center z-50" style="backdrop-filter: blur(4px);">
        <div class="bg-white rounded-2xl p-8 max-w-md w-full mx-4 shadow-2xl">
            <h3 class="text-2xl logo-font mb-6 text-gray-800">–ò–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å</h3>
            <select id="newStatus" class="w-full p-3 border border-gray-300 rounded-lg mb-6 focus:ring-2 focus:ring-gray-400 focus:border-transparent">
                <option value="–ù–æ–≤–∞—è">–ù–æ–≤–∞—è</option>
                <option value="–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞</option>
                <option value="–ó–∞–≤–µ—Ä—à–µ–Ω–∞">–ó–∞–≤–µ—Ä—à–µ–Ω–∞</option>
                <option value="–û—Ç–º–µ–Ω–µ–Ω–∞">–û—Ç–º–µ–Ω–µ–Ω–∞</option>
            </select>
            <div class="flex space-x-4">
                <button onclick="saveStatus()" class="flex-1 accent-bg hover-accent text-white py-3 rounded-lg font-semibold transition">
                    –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                </button>
                <button onclick="closeStatusModal()" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 py-3 rounded-lg font-semibold transition">
                    –û—Ç–º–µ–Ω–∞
                </button>
            </div>
        </div>
    </div>

    <script>
        let currentBookingId = null;
        let allBookings = [];
        let importedData = null;

        // –ó–∞–≥—Ä—É–∑–∫–∞ –º–∞—Å—Ç–µ—Ä–æ–≤ –≤ —Ñ–∏–ª—å—Ç—Ä (—Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏)
        function loadMastersFilter() {
            const masters = JSON.parse(localStorage.getItem('masters') || '[]');
            const select = document.getElementById('filterMaster');
            
            // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –æ–ø—Ü–∏–∏
            select.innerHTML = '<option value="">–í—Å–µ –º–∞—Å—Ç–µ—Ä–∞</option>';
            
            masters.forEach(master => {
                const option = document.createElement('option');
                option.value = master.id;
                option.textContent = master.name;
                select.appendChild(option);
            });
        }

        // –ò–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö –∏–∑ —Ñ–∞–π–ª–∞
        function importData() {
            const fileInput = document.getElementById('importFile');
            const file = fileInput.files[0];
            
            if (!file) return;
            
            showImportStatus('–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞...', 'bg-blue-50 text-blue-800');
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const content = e.target.result;
                    const extension = file.name.split('.').pop().toLowerCase();
                    
                    if (extension === 'csv') {
                        parseCSV(content);
                    } else if (extension === 'xlsx' || extension === 'xls') {
                        showImportStatus('–û—à–∏–±–∫–∞: –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ —Ñ–æ—Ä–º–∞—Ç CSV', 'bg-red-50 text-red-800');
                        setTimeout(hideImportStatus, 3000);
                    } else {
                        showImportStatus('–û—à–∏–±–∫–∞: –ù–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞', 'bg-red-50 text-red-800');
                        setTimeout(hideImportStatus, 3000);
                    }
                } catch (error) {
                    showImportStatus('–û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞: ' + error.message, 'bg-red-50 text-red-800');
                    setTimeout(hideImportStatus, 3000);
                }
            };
            
            reader.readAsText(file, 'UTF-8');
        }

        // –ü–∞—Ä—Å–∏–Ω–≥ CSV —Ñ–∞–π–ª–∞
        function parseCSV(content) {
            try {
                const lines = content.split('\n').filter(line => line.trim());
                if (lines.length < 2) {
                    throw new Error('–§–∞–π–ª –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –∑–∞–≥–æ–ª–æ–≤–∫–∏ –∏ –¥–∞–Ω–Ω—ã–µ');
                }
                
                const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
                const data = [];
                
                for (let i = 1; i < lines.length; i++) {
                    const values = parseCSVLine(lines[i]);
                    if (values.length === headers.length) {
                        const row = {};
                        headers.forEach((header, index) => {
                            row[header] = values[index];
                        });
                        data.push(row);
                    }
                }
                
                if (data.length === 0) {
                    throw new Error('–ù–µ –Ω–∞–π–¥–µ–Ω–æ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞');
                }
                
                importedData = { headers, data };
                showDataPreview();
                hideImportStatus();
                
            } catch (error) {
                showImportStatus('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ CSV: ' + error.message, 'bg-red-50 text-red-800');
                setTimeout(hideImportStatus, 3000);
            }
        }

        // –ü–∞—Ä—Å–∏–Ω–≥ —Å—Ç—Ä–æ–∫–∏ CSV —Å —É—á–µ—Ç–æ–º –∫–∞–≤—ã—á–µ–∫
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            
            result.push(current.trim());
            return result.map(item => item.replace(/"/g, ''));
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä –¥–∞–Ω–Ω—ã—Ö
        function showDataPreview() {
            const preview = document.getElementById('dataPreview');
            const headersContainer = document.getElementById('previewHeaders');
            const dataContainer = document.getElementById('previewData');
            
            // –ó–∞–≥–æ–ª–æ–≤–∫–∏
            let headersHTML = '<tr>';
            importedData.headers.forEach(header => {
                headersHTML += `<th class="text-left p-2 border-b font-semibold">${header}</th>`;
            });
            headersHTML += '</tr>';
            headersContainer.innerHTML = headersHTML;
            
            // –î–∞–Ω–Ω—ã–µ (–ø–µ—Ä–≤—ã–µ 5 —Å—Ç—Ä–æ–∫)
            let dataHTML = '';
            const previewRows = importedData.data.slice(0, 5);
            previewRows.forEach(row => {
                dataHTML += '<tr>';
                importedData.headers.forEach(header => {
                    dataHTML += `<td class="p-2 border-b">${row[header] || ''}</td>`;
                });
                dataHTML += '</tr>';
            });
            
            if (importedData.data.length > 5) {
                dataHTML += `<tr><td colspan="${importedData.headers.length}" class="p-2 text-center text-gray-500 italic">... –∏ –µ—â–µ ${importedData.data.length - 5} –∑–∞–ø–∏—Å–µ–π</td></tr>`;
            }
            
            dataContainer.innerHTML = dataHTML;
            preview.classList.remove('hidden');
        }

        // –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∏–º–ø–æ—Ä—Ç
        function confirmImport() {
            try {
                const bookings = JSON.parse(localStorage.getItem('bookings') || '[]');
                let importedCount = 0;
                
                importedData.data.forEach((row, index) => {
                    // –ú–∞–ø–ø–∏–Ω–≥ –ø–æ–ª–µ–π CSV –Ω–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—É booking
                    const booking = {
                        id: Date.now() + index + Math.floor(Math.random() * 1000), // –£–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –¥–ª—è –∫–∞–∂–¥–æ–π –∑–∞–ø–∏—Å–∏
                        serviceId: row['ID —É—Å–ª—É–≥–∏'] || row['serviceId'] || 'unknown',
                        serviceName: row['–£—Å–ª—É–≥–∞'] || row['serviceName'] || row['–ù–∞–∑–≤–∞–Ω–∏–µ —É—Å–ª—É–≥–∏'] || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è —É—Å–ª—É–≥–∞',
                        duration: parseInt(row['–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å'] || row['duration'] || '60'),
                        masterId: parseInt(row['ID –º–∞—Å—Ç–µ—Ä–∞'] || row['masterId'] || '1'),
                        masterName: row['–ú–∞—Å—Ç–µ—Ä'] || row['masterName'] || row['–ò–º—è –º–∞—Å—Ç–µ—Ä–∞'] || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –º–∞—Å—Ç–µ—Ä',
                        date: row['–î–∞—Ç–∞'] || row['date'] || new Date().toISOString().split('T')[0],
                        time: row['–í—Ä–µ–º—è'] || row['time'] || '10:00',
                        clientName: row['–ö–ª–∏–µ–Ω—Ç'] || row['clientName'] || row['–ò–º—è –∫–ª–∏–µ–Ω—Ç–∞'] || '–ù–µ —É–∫–∞–∑–∞–Ω–æ',
                        phone: row['–¢–µ–ª–µ—Ñ–æ–Ω'] || row['phone'] || row['–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞'] || '',
                        status: row['–°—Ç–∞—Ç—É—Å'] || row['status'] || '–ù–æ–≤–∞—è',
                        createdAt: new Date().toISOString()
                    };
                    
                    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –¥—É–±–ª–∏–∫–∞—Ç—ã –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É, –¥–∞—Ç–µ –∏ –≤—Ä–µ–º–µ–Ω–∏
                    const isDuplicate = bookings.some(existing => 
                        existing.phone === booking.phone && 
                        existing.date === booking.date && 
                        existing.time === booking.time
                    );
                    
                    if (!isDuplicate) {
                        bookings.push(booking);
                        importedCount++;
                    }
                });
                
                localStorage.setItem('bookings', JSON.stringify(bookings));
                
                showImportStatus(`–£—Å–ø–µ—à–Ω–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ ${importedCount} –∑–∞–ø–∏—Å–µ–π`, 'bg-green-50 text-green-800');
                setTimeout(() => {
                    hideImportStatus();
                    cancelImport();
                    loadBookings();
                }, 2000);
                
            } catch (error) {
                showImportStatus('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ: ' + error.message, 'bg-red-50 text-red-800');
                setTimeout(hideImportStatus, 3000);
            }
        }

        // –û—Ç–º–µ–Ω–∏—Ç—å –∏–º–ø–æ—Ä—Ç
        function cancelImport() {
            document.getElementById('dataPreview').classList.add('hidden');
            document.getElementById('importFile').value = '';
            importedData = null;
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç—É—Å –∏–º–ø–æ—Ä—Ç–∞
        function showImportStatus(message, className) {
            const status = document.getElementById('importStatus');
            const messageEl = document.getElementById('importMessage');
            
            status.className = `mb-6 p-4 rounded-lg ${className}`;
            messageEl.textContent = message;
            status.classList.remove('hidden');
        }

        // –°–∫—Ä—ã—Ç—å —Å—Ç–∞—Ç—É—Å –∏–º–ø–æ—Ä—Ç–∞
        function hideImportStatus() {
            document.getElementById('importStatus').classList.add('hidden');
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞—è–≤–æ–∫
        function loadBookings() {
            allBookings = JSON.parse(localStorage.getItem('bookings') || '[]');
            
            // –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤
            const filterDate = document.getElementById('filterDate').value;
            const filterMaster = document.getElementById('filterMaster').value;
            const filterStatus = document.getElementById('filterStatus').value;
            
            let filtered = allBookings;
            
            if (filterDate) {
                filtered = filtered.filter(b => b.date === filterDate);
            }
            if (filterMaster) {
                filtered = filtered.filter(b => b.masterId == filterMaster);
            }
            if (filterStatus) {
                filtered = filtered.filter(b => b.status === filterStatus);
            }
            
            // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –¥–∞—Ç–µ –∏ –≤—Ä–µ–º–µ–Ω–∏ (–Ω–æ–≤—ã–µ —Å–≤–µ—Ä—Ö—É)
            filtered.sort((a, b) => {
                const dateA = new Date(a.date + ' ' + a.time);
                const dateB = new Date(b.date + ' ' + b.time);
                return dateB - dateA;
            });
            
            displayBookings(filtered);
            updateStatistics(allBookings);
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–∞—è–≤–æ–∫
        function displayBookings(bookings) {
            const tbody = document.getElementById('bookingsTable');
            
            // –û—Ç–ª–∞–¥–∫–∞: –ø—Ä–æ–≤–µ—Ä–∏–º –¥–∞–Ω–Ω—ã–µ
            console.log('–û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∑–∞—è–≤–∫–∏:', bookings);
            bookings.forEach((booking, index) => {
                console.log(`–ó–∞—è–≤–∫–∞ ${index}:`, booking);
                console.log(`–ò–º—è –∫–ª–∏–µ–Ω—Ç–∞ –≤ –∑–∞—è–≤–∫–µ ${index}:`, booking.clientName);
            });
            
            if (bookings.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="px-4 py-8 text-center text-gray-500">–ù–µ—Ç –∑–∞—è–≤–æ–∫</td></tr>';
                return;
            }
            
            let html = '';
            bookings.forEach(booking => {
                const statusClass = getStatusClass(booking.status);
                const clientName = booking.clientName || '–ù–µ —É–∫–∞–∑–∞–Ω–æ';
                console.log(`–û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∏–º—è –∫–ª–∏–µ–Ω—Ç–∞: "${clientName}" –¥–ª—è –∑–∞—è–≤–∫–∏ #${booking.id}`);
                html += `<tr class="border-b border-gray-200 hover:bg-gray-50">
                    <td class="px-4 py-4 text-sm">#${booking.id}</td>
                    <td class="px-4 py-4 text-sm">${formatDate(booking.date)}</td>
                    <td class="px-4 py-4 text-sm font-medium">${booking.time}</td>
                    <td class="px-4 py-4 text-sm font-medium text-gray-900">${clientName}</td>
                    <td class="px-4 py-4 text-sm">${booking.masterName}</td>
                    <td class="px-4 py-4 text-sm">${booking.serviceName}</td>
                    <td class="px-4 py-4 text-sm">${booking.phone}</td>
                    <td class="px-4 py-4">
                        <span class="${statusClass} text-white px-3 py-1 rounded-full text-xs font-medium">
                            ${booking.status}
                        </span>
                    </td>
                    <td class="px-4 py-4">
                        <button onclick="openStatusModal(${booking.id})" class="text-blue-600 hover:text-blue-800 text-sm font-medium mr-3">
                            –ò–∑–º–µ–Ω–∏—Ç—å
                        </button>
                        <button onclick="deleteBooking(${booking.id})" class="text-red-600 hover:text-red-800 text-sm font-medium">
                            –£–¥–∞–ª–∏—Ç—å
                        </button>
                    </td>
                </tr>`;
            });
            
            tbody.innerHTML = html;
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        function updateStatistics(bookings) {
            const stats = {
                '–ù–æ–≤–∞—è': 0,
                '–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞': 0,
                '–ó–∞–≤–µ—Ä—à–µ–Ω–∞': 0,
                '–û—Ç–º–µ–Ω–µ–Ω–∞': 0
            };
            
            bookings.forEach(booking => {
                if (stats.hasOwnProperty(booking.status)) {
                    stats[booking.status]++;
                }
            });
            
            document.getElementById('statNew').textContent = stats['–ù–æ–≤–∞—è'];
            document.getElementById('statConfirmed').textContent = stats['–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞'];
            document.getElementById('statCompleted').textContent = stats['–ó–∞–≤–µ—Ä—à–µ–Ω–∞'];
            document.getElementById('statCancelled').textContent = stats['–û—Ç–º–µ–Ω–µ–Ω–∞'];
        }

        // –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–ª–∞—Å—Å–∞ –¥–ª—è —Å—Ç–∞—Ç—É—Å–∞
        function getStatusClass(status) {
            const classes = {
                '–ù–æ–≤–∞—è': 'status-new',
                '–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞': 'status-confirmed',
                '–ó–∞–≤–µ—Ä—à–µ–Ω–∞': 'status-completed',
                '–û—Ç–º–µ–Ω–µ–Ω–∞': 'status-cancelled'
            };
            return classes[status] || 'bg-gray-500';
        }

        // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞—Ç—ã
        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit', year: 'numeric' });
        }

        // –û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Å—Ç–∞—Ç—É—Å–∞
        function openStatusModal(bookingId) {
            currentBookingId = bookingId;
            const booking = allBookings.find(b => b.id === bookingId);
            document.getElementById('newStatus').value = booking.status;
            document.getElementById('statusModal').classList.remove('hidden');
            document.getElementById('statusModal').classList.add('flex');
        }

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
        function closeStatusModal() {
            document.getElementById('statusModal').classList.add('hidden');
            document.getElementById('statusModal').classList.remove('flex');
            currentBookingId = null;
        }

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
        function saveStatus() {
            const newStatus = document.getElementById('newStatus').value;
            const bookings = JSON.parse(localStorage.getItem('bookings') || '[]');
            const index = bookings.findIndex(b => b.id === currentBookingId);
            
            if (index !== -1) {
                bookings[index].status = newStatus;
                localStorage.setItem('bookings', JSON.stringify(bookings));
                loadBookings();
                closeStatusModal();
            }
        }

        // –£–¥–∞–ª–µ–Ω–∏–µ –∑–∞—è–≤–∫–∏
        function deleteBooking(bookingId) {
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞—è–≤–∫—É?')) return;
            
            const bookings = JSON.parse(localStorage.getItem('bookings') || '[]');
            const filtered = bookings.filter(b => b.id !== bookingId);
            localStorage.setItem('bookings', JSON.stringify(filtered));
            loadBookings();
        }

        // –°–±—Ä–æ—Å —Ñ–∏–ª—å—Ç—Ä–æ–≤
        function clearFilters() {
            document.getElementById('filterDate').value = '';
            document.getElementById('filterMaster').value = '';
            document.getElementById('filterStatus').value = '';
            loadBookings();
        }

        // –≠–∫—Å–ø–æ—Ä—Ç –≤ CSV
        function exportToCSV() {
            const headers = ['ID', '–î–∞—Ç–∞', '–í—Ä–µ–º—è', '–ö–ª–∏–µ–Ω—Ç', '–ú–∞—Å—Ç–µ—Ä', '–£—Å–ª—É–≥–∞', '–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å', '–¢–µ–ª–µ—Ñ–æ–Ω', '–°—Ç–∞—Ç—É—Å', '–°–æ–∑–¥–∞–Ω–æ'];
            const rows = allBookings.map(b => [
                b.id,
                b.date,
                b.time,
                b.clientName || '–ù–µ —É–∫–∞–∑–∞–Ω–æ',
                b.masterName,
                b.serviceName,
                b.duration,
                b.phone,
                b.status,
                new Date(b.createdAt).toLocaleString('ru-RU')
            ]);
            
            let csv = '\uFEFF' + headers.join(',') + '\n'; // BOM –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∫–∏—Ä–∏–ª–ª–∏—Ü—ã
            rows.forEach(row => {
                csv += row.map(cell => `"${cell}"`).join(',') + '\n';
            });
            
            const dataBlob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `bookings_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            URL.revokeObjectURL(url);
        }
    </script>
    </div> <!-- End of crmContent -->

    <script>
        // –°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
        const CRM_PASSWORD = '00000'; // –ü–∞—Ä–æ–ª—å –¥–ª—è CRM
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        document.addEventListener('DOMContentLoaded', () => {
            if (sessionStorage.getItem('crmAuthorized') === 'true') {
                showCRM();
            }
        });
        
        function checkPassword(event) {
            event.preventDefault();
            const password = document.getElementById('passwordInput').value;
            
            if (password === CRM_PASSWORD) {
                sessionStorage.setItem('crmAuthorized', 'true');
                showCRM();
            } else {
                document.getElementById('errorMessage').classList.remove('hidden');
                document.getElementById('passwordInput').value = '';
                document.getElementById('passwordInput').focus();
            }
        }
        
        function showCRM() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('crmContent').classList.remove('hidden');
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è CRM –ø–æ—Å–ª–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
            loadMastersFilter();
            loadBookings();
        }
        
        function logout() {
            sessionStorage.removeItem('crmAuthorized');
            document.getElementById('crmContent').classList.add('hidden');
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('passwordInput').value = '';
            document.getElementById('errorMessage').classList.add('hidden');
        }
    </script>
</body>
</html>
